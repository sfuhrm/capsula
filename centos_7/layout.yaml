# Details of a directory layout
# The following variables are defined:
# * jpkg: The jpkg yaml file
# * source: The source directory path
# * target: The target directory path
---
name: CentOS 7
prepare:
- copy:
    from: Dockerfile
    to: Dockerfile
- template:
    from: project.spec.ftl
    to: ${capsula.redhat.packageName}-${capsula.redhat.version}.spec
- run:
    command: docker build . -t centos_7_jpkg
# build docker image
- run:
    command: docker build . -t centos_7_jpkg
# clone project
- run:
    command: git clone ${capsula.gitUrl}
# remove .git files
- run:
    command: rm -fr ${capsula.gitProject}/.git ${capsula.gitProject}/.gitignore    
- run:
    command: mv ${capsula.gitProject} ${capsula.packageName}-${capsula.redhat.version}
  # make rpm builder directorys (see https://wiki.centos.org/HowTos/SetupRpmBuildEnvironment)
- run:
    command: mkdir -p root/rpmbuild/BUILD root/rpmbuild/RPMS root/rpmbuild/SOURCES root/rpmbuild/SRPMS   
- run:
    command: tar -czvf root/rpmbuild/SOURCES/${capsula.packageName}-${capsula.redhat.version}.tar.gz ${capsula.packageName}-${capsula.redhat.version}/    
- run:
    command: chmod a+rw root/rpmbuild/SOURCES/${capsula.packageName}-${capsula.redhat.version}.tar.gz 
- run:
    command: docker run -v${target}:/target -v${target}/root/rpmbuild:/root/rpmbuild -w/target centos_7_jpkg chown root:root /target/${capsula.redhat.packageName}-${capsula.redhat.version}.spec /target/root/rpmbuild/SOURCES/${capsula.packageName}-${capsula.redhat.version}.tar.gz 
- run:
    command: docker run -v${target}:/target -v${target}/root/rpmbuild:/root/rpmbuild -w/target centos_7_jpkg rpmbuild -ba ${capsula.redhat.packageName}-${capsula.redhat.version}.spec
