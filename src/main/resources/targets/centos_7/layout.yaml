---
name: CentOS 7
prepare:
- copy:
    from: Dockerfile
    to: Dockerfile
- template:
    from: project.spec.ftl
    to: ${capsula.redhat.packageName}-${version.version}.spec
# clone project
- run:
    command: git clone ${capsula.gitUrl}
# remove .git files
- run:
    command: rm -fr ${capsula.gitProject}/.git ${capsula.gitProject}/.gitignore    
- run:
    command: mv ${capsula.gitProject} ${capsula.redhat.packageName}-${version.version}
  # make rpm builder directorys (see https://wiki.centos.org/HowTos/SetupRpmBuildEnvironment)
- run:
    command: mkdir -p root/rpmbuild/BUILD root/rpmbuild/RPMS root/rpmbuild/SOURCES root/rpmbuild/SRPMS   
- run:
    command: tar -czvf root/rpmbuild/SOURCES/${capsula.redhat.packageName}-${version.version}.tar.gz ${capsula.redhat.packageName}-${version.version}/    
- run:
    command: chmod a+rw root/rpmbuild/SOURCES/${capsula.redhat.packageName}-${version.version}.tar.gz 
build:
# pull or build docker image
<#if use_dockerhub>
<#assign image = dockerhub_image>
- run:
    command: docker pull ${dockerhub_image}
<#else>
<#assign image = image_label>
- run:
    command: docker build . -t ${image}
</#if>
- run:
    command: docker run -v${target}:/target -v${target}/root/rpmbuild:/root/rpmbuild -w/target ${image} chown root:root /target/${capsula.redhat.packageName}-${version.version}.spec /target/root/rpmbuild/SOURCES/${capsula.redhat.packageName}-${version.version}.tar.gz 
- run:
    command: docker run -v${target}:/target -v${target}/root/rpmbuild:/root/rpmbuild -w/target ${image} rpmbuild -ba ${capsula.redhat.packageName}-${version.version}.spec
- run:
    command: docker run -v${target}:/target -w/target ${image} chmod -R a+rwx .
packages:
- root/rpmbuild/RPMS/noarch/${capsula.redhat.packageName}-${version.version}-${version.releaseNumber}.noarch.rpm
- root/rpmbuild/SRPMS/${capsula.redhat.packageName}-${version.version}-${version.releaseNumber}.src.rpm

