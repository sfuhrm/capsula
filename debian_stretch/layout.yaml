# Details of a directory layout
# The following variables are defined:
# * jpkg: The jpkg yaml file
# * source: The source directory path
# * target: The target directory path
# See: https://www.debian.org/doc/manuals/maint-guide/dreq.en.html
---
name: Debian Stretch
prepare:
- copy:
    from: Dockerfile
    to: Dockerfile
# build docker image
- run:
    command: docker build . -t debian_stretch_jpkg
# clone project
- run:
    command: git clone ${capsula.gitUrl}
# remove .git files
- run:
    command: rm -fr ${capsula.gitProject}/.git ${capsula.gitProject}/.gitignore
- run:
    command: mv ${capsula.gitProject} ${capsula.debian.packageName}_${capsula.version}
- run:
    command: docker run -v${target}:/target -w/target debian_stretch_jpkg tar -czvf ${capsula.debian.packageName}_${capsula.version}.orig.tar.gz ${capsula.debian.packageName}_${capsula.version}
- mkdir:
    to: ${capsula.debian.packageName}_${capsula.version}/debian/${capsula.debian.packageName}/DEBIAN
    mode: rwxrwxrwx
- run:
    command: echo ${capsula.gitProject}
- template:
    from: control.ftl
    to: ${capsula.debian.packageName}_${capsula.version}/debian/control
- template:
    from: copyright.ftl
    to: ${capsula.debian.packageName}_${capsula.version}/debian/copyright
- template:
    from: changelog.ftl
    to: ${capsula.debian.packageName}_${capsula.version}/debian/changelog
- template:
    from: rules.ftl
    to: ${capsula.debian.packageName}_${capsula.version}/debian/rules
    mode: rwxr-xr-x
#- template:
#    from: install.ftl
#    to: ${capsula.debian.packageName}_${capsula.version}/debian/install
#    mode: rwxr-xr-x
- template:
    from: Makefile.ftl
    to: ${capsula.debian.packageName}_${capsula.version}/Makefile
- template:
    from: compat.ftl
    to: ${capsula.debian.packageName}_${capsula.version}/debian/compat
- run:
    command: docker run -v${target}:/target -w/target/${capsula.debian.packageName}_${capsula.version} debian_stretch_jpkg debuild -us -uc
- run:
    command: docker run -v${target}:/target -w/target/${capsula.debian.packageName}_${capsula.version} debian_stretch_jpkg chmod -R a+rwx .
- run:
    command: docker run -v${target}:/target -w/target/${capsula.debian.packageName}_${capsula.version} debian_stretch_jpkg dpkg -i /target/${capsula.debian.packageName}_${capsula.version}-1_all.deb
environment:
  foo: bar

